#!/bin/sh

if [ "`whoami`"=="boinc" ]; then
	# Setup environment
	echo "${GUI_RPC_AUTH}" > /etc/boinc-client/gui_rpc_auth.cfg
	sed '/^[[:space:]]*$/d' > "/etc/boinc-client/global_prefs_override.xml" <<- END
	<global_preferences>
		${HOST_VENUE:+"<host_venue>$([ "${HOST_VENUE}" = "none" ] || echo "${HOST_VENUE}")</host_venue>"}
		<run_if_user_active>1</run_if_user_active>
		<run_gpu_if_user_active>1</run_gpu_if_user_active>
		${MAX_NCPUS_PCT:+"<max_ncpus_pct>${MAX_NCPUS_PCT}</max_ncpus_pct>"}
		${CPU_USAGE_LIMIT:+"<cpu_usage_limit>${CPU_USAGE_LIMIT}</cpu_usage_limit>"}
		<suspend_cpu_usage>50</suspend_cpu_usage>
		${RAM_MAX_USED_PCT:+"<ram_max_used_busy_pct>${RAM_MAX_USED_PCT}</ram_max_used_busy_pct>"}
		${MAX_NCPUS_PCT:+"<niu_max_ncpus_pct>${MAX_NCPUS_PCT}</niu_max_ncpus_pct>"}
		${CPU_USAGE_LIMIT:+"<niu_cpu_usage_limit>${CPU_USAGE_LIMIT}</niu_cpu_usage_limit>"}
		<niu_suspend_cpu_usage>50</niu_suspend_cpu_usage>
		${RAM_MAX_USED_PCT:+"<ram_max_used_idle_pct>${RAM_MAX_USED_PCT}</ram_max_used_idle_pct>"}
		<suspend_if_no_recent_input>0</suspend_if_no_recent_input>
		${CPU_SCHEDULING_PERIOD_MINUTES:+"<cpu_scheduling_period_minutes>${CPU_SCHEDULING_PERIOD_MINUTES}</cpu_scheduling_period_minutes>"}
		${DISK_INTERVAL:+"<disk_interval>${DISK_INTERVAL}</disk_interval>"}
		${LEAVE_APPS_IN_MEMORY:+"<leave_apps_in_memory>${LEAVE_APPS_IN_MEMORY}</leave_apps_in_memory>"}
		${WORK_BUF_MIN_DAYS:+"<work_buf_min_days>${WORK_BUF_MIN_DAYS}</work_buf_min_days>"}
		${WORK_BUF_ADDITIONAL_DAYS:+"<work_buf_additional_days>${WORK_BUF_ADDITIONAL_DAYS}</work_buf_additional_days>"}
		${DISK_MAX_USED_GB:+"<disk_max_used_gb>${DISK_MAX_USED_GB}</disk_max_used_gb>"}
		${DISK_MIN_FREE_GB:+"<disk_min_free_gb>${DISK_MIN_FREE_GB}</disk_min_free_gb>"}
		${DISK_MAX_USED_PCT:+"<disk_max_used_pct>${DISK_MAX_USED_PCT}</disk_max_used_pct>"}
	</global_preferences>
	END

	# Migrate from old image, can be removed at some point to allow own files
	if [ -f /var/lib/boinc-client/cc_config.xml ] && [ ! -h /var/lib/boinc-client/cc_config.xml ]; then
		rm -f /var/lib/boinc-client/cc_config.xml
		ln -s /etc/boinc-client/cc_config.xml /var/lib/boinc-client/cc_config.xml
	fi
	if [ -f /var/lib/boinc-client/global_prefs_override.xml ] && [ ! -h /var/lib/boinc-client/global_prefs_override.xml ]; then
		rm -f /var/lib/boinc-client/global_prefs_override.xml
		ln -s /etc/boinc-client/global_prefs_override.xml /var/lib/boinc-client/global_prefs_override.xml
	fi

	# tool setup
	cat > "/var/lib/boinc-client/.boinctui.cfg" <<- END
	<boinctui_cfg>
		<server>
			<host>localhost</host>
			<pwd>${GUI_RPC_AUTH}</pwd>
			<port>31416</port>
			<hostid>docker</hostid>
		</server>
		<version>2.7.0</version>
		<transparent_background>1</transparent_background>
	</boinctui_cfg>
	END

	cp -rn /etc/skel/. /var/lib/boinc-client/
	if [ ! -f "/var/lib/boinc-client/.vimrc" ]; then
		cat > "/var/lib/boinc-client/.vimrc" <<- END
		runtime! debian.vim
		set mouse=a
		map <Tab> :tabnext<CR>
		map <S-Tab> :tabprevious<CR>
		END
	fi

	if [ "$0"=="/bin/sh" ] && [ -z "$*" ]; then
		# This makes boinctui appear in Docker Desktop on the Exec tab
		boinctui
		bash -l && exit || echo -n "\n[$0] `whoami`@`hostname`"
	fi
fi

test -n "$*" && exec "$@"
