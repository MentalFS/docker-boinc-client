#!/bin/sh

if [ "`whoami`"=="boinc" ]; then
	# Setup environment
	echo "${GUI_RPC_AUTH}" > /etc/boinc-client/gui_rpc_auth.cfg

	cat > "/var/lib/boinc-client/global_prefs_override.xml" <<- END
	<global_preferences>
		${HOST_VENUE:+"<host_venue>${HOST_VENUE#none}</host_venue>"}
		${CPU_SCHEDULING_PERIOD_MINUTES:+"<cpu_scheduling_period_minutes>${CPU_SCHEDULING_PERIOD_MINUTES}</cpu_scheduling_period_minutes>"}
		<cpu_usage_limit>${CPU_USAGE_LIMIT}</cpu_usage_limit>
		<max_ncpus_pct>${MAX_NCPUS_PCT}</max_ncpus_pct>
		<run_gpu_if_user_active>1</run_gpu_if_user_active>
		<run_if_user_active>1</run_if_user_active>
		<suspend_cpu_usage>75</suspend_cpu_usage>
		<suspend_if_no_recent_input>0</suspend_if_no_recent_input>
        ${GLOBAL_PREFERENCES_XML}
	</global_preferences>
	END

	cat > "/var/lib/boinc-client/.boinctui.cfg" <<- END
	<boinctui_cfg>
		<server>
			<host>localhost</host>
			<pwd>${GUI_RPC_AUTH}</pwd>
			<port>31416</port>
			<hostid>docker</hostid>
		</server>
		<version>2.7.0</version>
		<transparent_background>1</transparent_background>
	</boinctui_cfg>
	END

	cp -rn /etc/skel/. /var/lib/boinc-client/
	if [ ! -f "/var/lib/boinc-client/.vimrc" ]; then
		cat > "/var/lib/boinc-client/.vimrc" <<- END
		runtime! debian.vim
		set mouse=a
		map <Tab> :tabnext<CR>
		map <S-Tab> :tabprevious<CR>
		END
	fi

	if [ "$0"=="/bin/sh" ] && [ -z "$*" ]; then
		# This makes boinctui appear in Docker Desktop on the Exec tab
		boinctui
		bash -l && exit || echo -n "\n[$0] `whoami`@`hostname`"
	fi
fi

test -n "$*" && exec "$@"
