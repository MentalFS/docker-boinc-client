#!/bin/sh

if [ "`whoami`"=="boinc" ]; then
	# Setup environment
	echo "${GUI_RPC_AUTH}" > /etc/boinc-client/gui_rpc_auth.cfg

	cat > "/var/lib/boinc-client/global_prefs_override.xml" <<- END
	<global_preferences>
		<run_if_user_active>1</run_if_user_active>
		<run_gpu_if_user_active>1</run_gpu_if_user_active>
		<suspend_if_no_recent_input>0</suspend_if_no_recent_input>
		<max_ncpus_pct>${MAX_NCPUS_PCT}</max_ncpus_pct>
		<cpu_usage_limit>${CPU_USAGE_LIMIT}</cpu_usage_limit>
	</global_preferences>
	END

	cat > "/var/lib/boinc-client/.boinctui.cfg" <<- END
	<boinctui_cfg>
		<server>
			<host>localhost</host>
			<pwd>${GUI_RPC_AUTH}</pwd>
			<port>31416</port>
			<hostid>localhost</hostid>
		</server>
		<version>2.7.0</version>
		<transparent_background>1</transparent_background>
	</boinctui_cfg>
	END

	if [ "$0"=="/bin/sh" ] && [ -z "$*" ]; then
		# This makes boinctui appear in Docker Desktop on the Exec tab
		boinctui
	fi
fi

test -n "$*" && exec "$@"
